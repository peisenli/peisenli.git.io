<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>手机通信录备份设计 | 帅的如此过分</title><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><link rel="icon" href="/favicon.ico"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">空空</div><div class="author-info__description text-center">非宁静无以致远，非淡泊无以明志</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">10</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">10</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2019/05/12/5cd78b8a60164.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">帅的如此过分</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">手机通信录备份设计</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-07-13 </time></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><p>一、设计目的  </p>
<ol>
<li>利用课程所学知识进行面向对象程序设计，理解类、对象、封装等概念。  </li>
<li>熟练掌握C++程序设计  </li>
<li>学会使用UML分析  </li>
<li>完成手机通信录备份设计<a id="more"></a>       
二、设计要求<br>手机通信录备份：  </li>
<li>实现可以将通信录备份到预先设定的服务器数据库中。  </li>
<li>数据库使用SQLite。  </li>
<li>同时备份到TF卡中。  </li>
<li>Android下通信部分用C++完成，界面用JAVA完成，之间采用JNI调用。  </li>
<li>需要有完整的设计文档。  </li>
</ol>
<p>三、设计需求<br>实验环境：Android Studio3.2、Linux服务器、SQLite<br>设计语言：C++、Java<br>四、设计步骤<br>在进行系统设计之前进行系统分析，确定人员分工，分工完成后进行通信录备份系统设计。  </p>
<p>1.安卓端设计<br>安卓端设计采用Android Studio3.2，设计使用的版本是Android6.0，根据设计要求首先需要进行本地文件备份，然后进行通信录数据上传到服务器中，界面包含两个Button按钮，两个TextView以及一个ListView，其中点击第一个Button按钮进行通信录数据读取后写入Txt文件并存入本地TF卡中，第二个Button按键将Txt文件通过网络通信传到服务器中，TextView用于显示备份状态，另外ListView显示上传的通信录信息，并显示是否通信成功，初始界面如下所示：<br>通信录读取过程主要是对安卓客户端的通信录的数据库进行读取，读取和写入TF卡都需要进行权限申请，注意Android6.0以上的权限需要进行动态申请。设计动态申请权限包括内存读写以及通信录读写。实现如下所示：<br><code>codes</code><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_EXTERNAL_STORAGE = <span class="number">1</span>;  </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] PERMISSIONS_STORAGE = &#123;  </span><br><span class="line">        <span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span>,  </span><br><span class="line">        <span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>,  </span><br><span class="line">        <span class="string">"android.permission.READ_CONTACTS"</span>,  </span><br><span class="line">        <span class="string">"android.permission.WRITE_CONTACTS"</span>&#125;;  </span><br><span class="line"><span class="comment">//确定动态权限获取  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> verifyStoragePermissions(Activity activity) &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="comment">//检测是否有写的权限  </span></span><br><span class="line">        <span class="keyword">int</span> permission = ActivityCompat.checkSelfPermission(activity,  </span><br><span class="line">                <span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>);  </span><br><span class="line">        <span class="keyword">if</span> (permission != PackageManager.PERMISSION_GRANTED) &#123;  </span><br><span class="line">            <span class="comment">// 没有写的权限，去申请写的权限，会弹出对话框  </span></span><br><span class="line">            ActivityCompat.requestPermissions(activity, PERMISSIONS_STORAGE, REQUEST_EXTERNAL_STORAGE);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(context,android.Manifest.permission.READ_CONTACTS)  </span><br><span class="line">                !=PackageManager.PERMISSION_GRANTED) &#123;  </span><br><span class="line">            ActivityCompat.requestPermissions((Activity) context,  </span><br><span class="line">                    <span class="keyword">new</span> String[]&#123;android.Manifest.permission.READ_CONTACTS&#125;,  </span><br><span class="line">                    <span class="number">1</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//另外，在安卓中的XML文件AndroidManifest.xml也需要加入权限：  </span></span><br><span class="line">&lt;uses-permission <span class="string">android:</span>name=<span class="string">"android.permission.READ_CONTACTS"</span>/&gt;  </span><br><span class="line">&lt;uses-permission <span class="string">android:</span>name=<span class="string">"android.permission.WRITE_CONTACTS"</span>/&gt;  </span><br><span class="line">&lt;uses-permission <span class="string">android:</span>name=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span>/&gt;  </span><br><span class="line">&lt;uses-permission <span class="string">android:</span>name=<span class="string">"android.permission.INTERNET"</span></span><br></pre></td></tr></table></figure></p>
<p>Android手机的通讯录联系人全部都存在系统的数据库中，如果须要获得通讯里联系人的信息就须要访问系统的数据库，才能将信息拿出来。对数据库查询代码主要如下所示：<br><code>codes</code><br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Cursor <span class="built_in">cursor</span> = context  </span><br><span class="line">        .getContentResolver()  </span><br><span class="line">        .query(ContactsContract.Data.CONTENT_URI,  </span><br><span class="line">                <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;StructuredName.DISPLAY_NAME,  </span><br><span class="line">                       Data.RAW_CONTACT_ID&#125;, Data.MIMETYPE + <span class="string">"= ?"</span>,  </span><br><span class="line">                <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;StructuredName.CONTENT_ITEM_TYPE&#125;, <span class="keyword">null</span>);  </span><br><span class="line"><span class="comment">// 得到电话号码的游标  </span></span><br><span class="line">Cursor mobileCursor = context.getContentResolver().query(  </span><br><span class="line">        ContactsContract.Data.CONTENT_URI,  </span><br><span class="line">        <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;Phone.NUMBER&#125;,  </span><br><span class="line">        Data.RAW_CONTACT_ID + <span class="string">" = "</span> + id + <span class="string">" AND "</span> + Data.DATA2  </span><br><span class="line">                + <span class="string">" = "</span> + <span class="number">2</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);  </span><br><span class="line"><span class="keyword">String</span> mobileNum = <span class="string">""</span>;  </span><br><span class="line"><span class="keyword">if</span> (mobileCursor.moveToNext()) &#123;  </span><br><span class="line">    mobileNum = mobileCursor.getString(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">mobileCursor.close();  </span><br><span class="line"><span class="comment">// 得到家庭电话  </span></span><br><span class="line">Cursor homeCursor = context.getContentResolver().query(  </span><br><span class="line">        ContactsContract.Data.CONTENT_URI,  </span><br><span class="line">        <span class="keyword">new</span> <span class="keyword">String</span>[]&#123;Phone.NUMBER&#125;,  </span><br><span class="line">        Data.RAW_CONTACT_ID + <span class="string">" = "</span> + id + <span class="string">" AND "</span> + Data.DATA2  </span><br><span class="line">                + <span class="string">" = "</span> + <span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure></p>
<p>将读取到的文件进行本地存储，写入到TF卡，其权限在使用之前已经进行申请，其写入主要代码如下所示：<br>private void writeFile(String path, String info) {<br>    try {<br>        File file = new File(path);<br>        FileWriter writer = new FileWriter(file, false);<br>        writer.write(info);<br>        writer.close();<br>    } catch (IOException e) {<br>        e.printStackTrace();<br>    }<br>}  </p>
<p>2.JNI配置<br>JNI的全称就是Java Native Interface，顾名思义，就是Java和C/C++相互通信的接口，就好比买卖房子都需要找中介一样，这里的JNI就是Java和C/C++通信的中介，一个中间人。<br>首先创建JNI类：<br><img src="https://i.loli.net/2019/05/10/5cd52b25bb387.png" alt="图片1.png"><br>配置 Anroid Studio 外部工具，File-&gt;Setting-&gt;Tools-&gt;External Tools-&gt;“+”，进入配置，完成之后如下图所示，先配置Javah。<br><img src="https://i.loli.net/2019/05/10/5cd52bcab9ff0.png" alt="图片2.png"><br>以相同的方式配置ndk-build。配置完成之后如图所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcabc4c5.png" alt="图片3.png"><br>修改app下的build.gradle文件, 如下图所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcab194a.png" alt="图片4.png"><br>并在项目下的gradle.properties文件添加代码：android.useDeprecatedNdk=true 生成JNI程序文件，点击JNI类文件，开始生成.h文件，选中JNI类右键-&gt;New-&gt;External Tools-&gt;javah，文件生成后如下所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcabe481.png" alt="图片5.png"><br>选中JNI类右键-&gt;New-&gt;External Tools-&gt;ndk-build，结果如图：<br><img src="https://i.loli.net/2019/05/10/5cd52bcac0a06.png" alt="图片6.png"><br>生成.h文件之后,根据生成的接口进行程序设计，接口函数如下所示：<br><img src="https://i.loli.net/2019/05/10/5cd52d056329a.png" alt="图片12.png"><br>新建立一个C++文件，在其中加入通信部分相关代码：<br><img src="https://i.loli.net/2019/05/10/5cd52bcaf07c3.png" alt="图片7.png"></p>
<p>安卓端整个设计完毕，最后进行调试生成相应的App应用，进行测试和完善，完成整体的设计。<br>3.服务器配置<br>服务器使用C++进行程序设计，服务器采用Centos6.8，配置好GCC-C++、SQLite环境之后，客户端使用Socket接口进行访问。将通信录信息传递到服务后进行相应的处理，存入数据库。启动界面如下图所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcac29b2.png" alt="图片8.png"><br>服务器程序中数据库存储部分具体见通信部分。<br>4.系统设计UML图<br>用户打开安卓界面，安卓获取本机通讯录打包好将信息给C++接口程序，同时保存数据到SD卡；C++接口程序通过Socket连接远程服务器，上传数据；服务器端接收数据，并插入到本地数据库，UML如图所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcacdd51.png" alt="图片9.png"><br>五、实验结果<br>根据设计要求，完成相应的工作，并进行测试，当用户进行使用时，首先开启服务器端接收部分进行监听，当安卓客户端点击备份和上传时，测试结果如下所示，客户端显示如下：<br><img src="https://i.loli.net/2019/05/10/5cd52bcad11c7.png" alt="图片10.png"><br>服务器测试如下所示：<br><img src="https://i.loli.net/2019/05/10/5cd52bcac897a.png" alt="图片11.png"><br>六、设计总结<br>本次设计深入了解面向对象设计方法，学习了JNI相关知识以及UML的设计，对C++程序又了进一步的了解，设计有所不足，服务器未考虑到多用户并发数据备份，另外安卓客户端比较简单，需要更多的优化设计。  </p>
</div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android-C-JNI/">Android C++ JNI</a></div></article><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/05/11/Chat-based-on-Socket/"><i class="fa fa-chevron-left">  </i><span>Chat based on Socket</span></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">©2016 - 2019 By 空空</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span> |  </span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/fancybox.js"></script><script src="/js/sidebar.js"></script><script src="/js/copy.js"></script><script src="/js/fireworks.js"></script><script src="/js/transition.js"></script><script src="/js/scroll.js"></script><script src="/js/head.js"></script></body></html>